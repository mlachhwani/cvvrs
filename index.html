<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVVRS ANALYSIS - SECR RAIPUR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        .violation-red { background-color: #fee2e2 !important; border: 1px solid #ef4444 !important; }
        .cat-header { background: #1e293b; color: #fff; padding: 10px; font-weight: 800; font-size: 14px; text-transform: uppercase; border-left: 5px solid #eab308; }
        .sub-label { font-size: 10px; font-weight: 800; color: #475569; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .point-row { border-bottom: 1px solid #e2e8f0; }
        .point-row:hover { background-color: #f8fafc; }
        select { font-size: 11px !important; font-weight: bold; border: 1px solid #94a3b8; border-radius: 4px; padding: 2px; background: white; }
        input:read-only { background-color: transparent; color: #1e40af; font-weight: 700; border: none; font-size: 11px; }
        .official-border { border: 2px solid #000; }
    </style>
</head>
<body class="bg-slate-200 p-2 md:p-6">

<div class="max-w-6xl mx-auto bg-white shadow-2xl official-border">
    <div class="p-4 border-b-2 border-black flex items-center justify-between bg-white">
        <img src="ir_logo.png" alt="IR Logo" class="w-20 h-20 object-contain">
        <div class="text-center flex-1">
            <h2 class="text-xl font-bold">SOUTH EAST CENTRAL RAILWAY</h2>
            <h3 class="text-md font-semibold text-blue-900 uppercase">Electrical (OP) Department - Raipur Division</h3>
            <h1 class="text-2xl font-black mt-2 bg-black text-white inline-block px-8 py-1">CVVRS CREW ANALYSIS REPORT</h1>
        </div>
        <div class="w-20"></div> </div>

    <form id="cvvrsForm" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-4 border rounded-lg mb-6">
            <div class="border-r pr-4">
                <span class="sub-label text-red-700">CLI Incharge Details</span>
                <input type="text" id="cli_id" onchange="lookup('cli')" class="w-full border-b-2 border-gray-300 p-1 font-bold uppercase outline-none focus:border-blue-600" placeholder="ENTER CMS ID">
                <input type="text" id="cli_name" readonly class="w-full mt-1" placeholder="CLI Name">
                <input type="text" id="cli_desig" readonly class="w-full text-gray-500 italic" placeholder="Designation & HQ">
            </div>
            <div class="grid grid-cols-2 gap-2 border-r pr-4">
                <div class="col-span-2"><span class="sub-label">Journey Details</span></div>
                <input type="text" id="train_no" placeholder="TRAIN NO" class="border p-2 font-bold uppercase rounded">
                <input type="text" id="loco_no" placeholder="LOCO NO" class="border p-2 font-bold uppercase rounded">
                <input type="text" id="from_stn" placeholder="FROM" class="border p-2 uppercase rounded">
                <input type="text" id="to_stn" placeholder="TO" class="border p-2 uppercase rounded">
            </div>
            <div>
                <span class="sub-label">Timings</span>
                <div class="space-y-2">
                    <div class="flex items-center gap-2"><span class="text-[9px] font-bold w-8">DEP:</span><input type="datetime-local" id="dep_time" class="border p-1 text-xs flex-1"></div>
                    <div class="flex items-center gap-2"><span class="text-[9px] font-bold w-8">ARR:</span><input type="datetime-local" id="arr_time" class="border p-1 text-xs flex-1"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-8 mb-8">
            <div class="p-4 bg-blue-50 border-l-8 border-blue-900 rounded-r-lg">
                <span class="sub-label font-black text-blue-900 mb-2">Loco Pilot (LP)</span>
                <input type="text" id="lp_id" onchange="lookup('lp')" placeholder="LP CMS ID" class="w-full border-b-2 border-blue-200 p-2 font-black uppercase mb-2 outline-none">
                <div class="grid grid-cols-1 gap-1">
                    <input type="text" id="lp_name" readonly placeholder="NAME" class="font-bold">
                    <input type="text" id="lp_desig" readonly placeholder="DESIGNATION">
                    <input type="text" id="lp_gcli" readonly placeholder="GRADE / HQ" class="text-[10px] text-gray-500">
                </div>
            </div>
            <div class="p-4 bg-orange-50 border-l-8 border-orange-600 rounded-r-lg">
                <span class="sub-label font-black text-orange-900 mb-2">Asstt. Loco Pilot (ALP)</span>
                <input type="text" id="alp_id" onchange="lookup('alp')" placeholder="ALP CMS ID" class="w-full border-b-2 border-orange-200 p-2 font-black uppercase mb-2 outline-none">
                <div class="grid grid-cols-1 gap-1">
                    <input type="text" id="alp_name" readonly placeholder="NAME" class="font-bold">
                    <input type="text" id="alp_desig" readonly placeholder="DESIGNATION">
                    <input type="text" id="alp_gcli" readonly placeholder="GRADE / HQ" class="text-[10px] text-gray-500">
                </div>
            </div>
        </div>

        <div id="observationContent" class="space-y-6">
            </div>

        <div class="mt-12 p-8 bg-slate-900 text-center rounded-xl shadow-2xl">
            <p id="statusMsg" class="text-yellow-400 font-bold mb-4 text-sm animate-pulse"></p>
            <button type="submit" id="submitBtn" class="bg-yellow-500 text-black px-16 py-5 rounded-full font-black text-lg hover:bg-white transition-all uppercase tracking-tighter">
                Confirm Sync & Generate Official Report
            </button>
        </div>
    </form>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby__yyf6tBaMvI69wNqBSqmquKAyqB2cpLhhxBkfP_GXYGN7ysw8Yvtr4mQ5p_19p-q/exec";
    const GITHUB_RAW = "https://raw.githubusercontent.com/mlachhwani/cvvrs/main/";

    const stages = [
        { id: "cto", title: "Stage I: During CTO (Sign ON)", 
          lp: ["Logbook & BPC Check", "Safety Items & HTC", "Energy Meter & SPM Check"],
          alp: ["RS Valve Working", "Safety Items & HTC", "Energy Meter/SPM Input"] 
        },
        { id: "run", title: "Stage II: ON RUN (In Motion)", 
          lp: ["Look Back in Curve/Points", "Signal Call Gesture", "Exchange of Signals", "Neutral Section Action", "Alertness Level", "Mobile Phone Use", "Micro Sleep Status"],
          alp: ["Standing & Holding RS", "Signal Call Gesture", "Exchange of Signals", "Formation/Caution Check", "Alertness Level", "Mobile Phone Use", "Micro Sleep Status"] 
        },
        { id: "halt", title: "Stage III: AT HALTS / STATIONS", 
          lp: ["Conducting BFT & BPT", "Undergear Check", "Headlight Dimming"],
          alp: ["Undergear/Machine Room", "Ensure Dimming", "Standing at Footplate"] 
        },
        { id: "cho", title: "Stage IV: At CHO (Sign OFF)", 
          lp: ["A9 & SA9 Application", "Reverser in Neutral", "Packing Belongings"],
          alp: ["Ensure A9/SA9 Applied", "Ensure Reverser Neutral", "Packing Belongings"] 
        }
    ];

    const obsContainer = document.getElementById('observationContent');
    stages.forEach(s => {
        let html = `<div class="cat-header">${s.title}</div><div class="grid grid-cols-2 gap-0 border-x border-b border-gray-300">`;
        
        // LP Column
        html += `<div class="border-r p-2 bg-blue-50/30">`;
        s.lp.forEach((p, i) => {
            html += `
            <div class="point-row flex justify-between items-center py-2 px-1" id="lp_row_${s.id}_${i}">
                <span class="text-[11px] font-semibold text-gray-700 w-2/3">${i+1}. ${p}</span>
                <div class="flex flex-col items-end">
                    <select name="lp_${s.id}_${i}" onchange="checkV('lp','${s.id}',${i},'YES')">
                        <option>YES</option><option>POOR</option><option>VIOLATION</option>
                    </select>
                    <input type="file" name="img_lp_${s.id}_${i}" class="hidden w-24 text-[7px] mt-1">
                </div>
            </div>`;
        });
        html += `</div>`;

        // ALP Column
        html += `<div class="p-2 bg-orange-50/30">`;
        s.alp.forEach((p, i) => {
            html += `
            <div class="point-row flex justify-between items-center py-2 px-1" id="alp_row_${s.id}_${i}">
                <span class="text-[11px] font-semibold text-gray-700 w-2/3">${i+1}. ${p}</span>
                <div class="flex flex-col items-end">
                    <select name="alp_${s.id}_${i}" onchange="checkV('alp','${s.id}',${i},'YES')">
                        <option>YES</option><option>POOR</option><option>VIOLATION</option>
                    </select>
                    <input type="file" name="img_alp_${s.id}_${i}" class="hidden w-24 text-[7px] mt-1">
                </div>
            </div>`;
        });
        html += `</div></div>`;
        obsContainer.innerHTML += html;
    });

    async function lookup(type) {
        let id = document.getElementById(type+'_id').value.toUpperCase();
        if(!id) return;
        try {
            let res = await fetch(GITHUB_RAW + (type==='cli'?'cli_master.csv':'crew_master.csv'));
            let text = await res.text();
            let found = text.split("\n").map(r=>r.split(",")).find(r=>r[0].trim().toUpperCase()===id);
            if(found) {
                document.getElementById(type+'_name').value = found[1].trim();
                document.getElementById(type+'_desig').value = found[2].trim();
                if(document.getElementById(type+'_gcli')) document.getElementById(type+'_gcli').value = found[3].trim();
            }
        } catch(e) {}
    }

    function checkV(t, stage, idx, def) {
        let sel = document.getElementsByName(`${t}_${stage}_${idx}`)[0];
        let file = document.getElementsByName(`img_${t}_${stage}_${idx}`)[0];
        let isV = (sel.value !== "YES" && sel.value !== "Yes" && !sel.value.includes("DAY"));
        file.classList.toggle('hidden', !isV);
        document.getElementById(`${t}_row_${stage}_${idx}`).classList.toggle('violation-red', isV);
    }

    document.getElementById('cvvrsForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('statusMsg');
        btn.disabled = true;
        status.innerText = "⏳ STEP 1: UPLOADING TO SECR CLOUD... PLEASE DO NOT CLOSE";

        const fd = new FormData(this);
        const obj = Object.fromEntries(fd.entries());
        
        ['cli_id','cli_name','lp_name','alp_name','lp_desig','alp_desig','train_no','loco_no','dep_time','arr_time','from_stn','to_stn'].forEach(k=>{
            const el = document.getElementById(k); if(el) obj[k] = el.value;
        });

        const files = document.querySelectorAll('input[type="file"]');
        for (let f of files) {
            if (f.files[0]) {
                obj[f.name] = await new Promise(r => {
                    const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f.files[0]);
                });
            }
        }

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(obj) });
            status.innerText = "✅ SYNCED! STEP 2: GENERATING OFFICIAL PDF...";
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            // Official Letterhead Branding in PDF
            doc.setFontSize(14); doc.text("SOUTH EAST CENTRAL RAILWAY", 105, 15, {align:'center'});
            doc.setFontSize(10); doc.text("RAIPUR DIVISION - ELECTRICAL (OP) DEPARTMENT", 105, 20, {align:'center'});
            doc.setFontSize(16); doc.setFont(undefined, 'bold'); doc.text("CVVRS ANALYSIS REPORT", 105, 30, {align:'center'});
            
            // PDF Details and Photos...
            doc.save(`SECR_CVVRS_${obj.loco_no}.pdf`);
            alert("REPORT COMPLETED SUCCESSFULLY!");
            location.reload();
        } catch(e) { alert("CONNECTION ERROR!"); btn.disabled = false; }
    };
</script>
</body>
</html>
