<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVVRS ANALYSIS SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        .violation-red { background-color: #fee2e2 !important; border: 1px solid #ef4444 !important; }
        .section-header { background: #0f172a; color: white; padding: 4px 10px; font-weight: bold; font-size: 12px; text-transform: uppercase; margin-top: 10px; }
        .point-text { font-size: 11px; line-height: 1.2; font-weight: 500; color: #1e293b; }
        select { font-size: 11px !important; padding: 2px !important; font-weight: bold; border: 1px solid #cbd5e1; border-radius: 4px; width: 80px; }
        input[type="text"] { font-size: 12px; }
        input:read-only { background-color: #f1f5f9; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-200 p-2 md:p-4">

<div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden border-t-4 border-blue-900">
    <div class="p-4 bg-slate-50 border-b">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase">CLI CMS ID</label>
                <input type="text" id="cli_id" name="cli_id" onchange="lookup('cli')" class="w-full border p-1 uppercase font-bold" required>
                <input type="text" id="cli_name" name="cli_name" readonly class="w-full text-[11px] font-bold text-blue-800 outline-none mt-1">
            </div>
            <div><label class="block text-[10px] font-bold text-gray-500 uppercase">Departure</label><input type="datetime-local" id="dep_time" name="dep_time" class="w-full border p-1 text-xs" required></div>
            <div><label class="block text-[10px] font-bold text-gray-500 uppercase">Arrival</label><input type="datetime-local" id="arr_time" name="arr_time" class="w-full border p-1 text-xs" required></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="text" name="train_no" id="train_no" placeholder="TRAIN NO" class="border p-2 text-xs font-bold uppercase" required>
            <input type="text" name="loco_no" id="loco_no" placeholder="LOCO NO" class="border p-2 text-xs font-bold uppercase" required>
            <input type="text" id="from_code" name="from_stn" placeholder="FROM" onchange="lookupStation('from')" class="border p-2 text-xs uppercase">
            <input type="text" id="to_code" name="to_stn" placeholder="TO" onchange="lookupStation('to')" class="border p-2 text-xs uppercase">
        </div>
    </div>

    <div class="grid grid-cols-2 gap-0 border-b">
        <div class="p-2 bg-blue-50 border-r">
            <input type="text" id="lp_id" name="lp_id" placeholder="LP ID" onchange="lookup('lp')" class="w-full border p-1 text-xs font-bold uppercase mb-1" required>
            <input type="text" id="lp_name" name="lp_name" readonly class="w-full text-[10px] font-bold text-blue-700 bg-transparent outline-none" placeholder="LP NAME">
        </div>
        <div class="p-2 bg-orange-50">
            <input type="text" id="alp_id" name="alp_id" placeholder="ALP ID" onchange="lookup('alp')" class="w-full border p-1 text-xs font-bold uppercase mb-1" required>
            <input type="text" id="alp_name" name="alp_name" readonly class="w-full text-[10px] font-bold text-orange-700 bg-transparent outline-none" placeholder="ALP NAME">
        </div>
    </div>

    <form id="cvvrsForm">
        <div id="observationSections" class="p-2"></div>
        
        <div class="p-4 bg-slate-100 border-t text-center">
            <button type="submit" id="submitBtn" class="bg-blue-900 text-white px-8 py-3 rounded-md font-bold text-sm hover:bg-black transition-all uppercase tracking-widest">
                START SYNC & GENERATE PDF
            </button>
            <p id="statusMsg" class="mt-2 text-[10px] font-bold text-blue-600 uppercase"></p>
        </div>
    </form>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby__yyf6tBaMvI69wNqBSqmquKAyqB2cpLhhxBkfP_GXYGN7ysw8Yvtr4mQ5p_19p-q/exec";
    const GITHUB_USER = "mlachhwani";
    const GITHUB_REPO = "cvvrs";
    const GITHUB_RAW = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/`;

    const sections = [
        { title: "During CTO (Sign ON)", points: [
            {id: 1, p: "Logbook/BPC/RS Valve", lp: "YES", alp: "Yes"},
            {id: 2, p: "Safety Items & HTC", lp: "YES", alp: "Yes"},
            {id: 3, p: "Energy Meter & SPM", lp: "YES", alp: "Yes"}
        ]},
        { title: "ON RUN", points: [
            {id: 4, p: "Signal Call Gesture", lp: "YES", alp: "Yes"},
            {id: 5, p: "Exchange of Signals", lp: "YES", alp: "Yes"},
            {id: 6, p: "Neutral/Caution Action", lp: "YES", alp: "Yes"},
            {id: 7, p: "Mobile Phone Use", lp: "No", alp: "No"},
            {id: 8, p: "Micro Sleep", lp: "No", alp: "No"},
            {id: 9, p: "Alertness Level", lp: "Very Good", alp: "Very Good"},
            {id: 10, p: "Whistle before Start", lp: "YES", alp: "YES"}
        ]},
        { title: "AT HALTS", points: [
            {id: 11, p: "BFT-BPT/Holding RS", lp: "YES", alp: "Yes"},
            {id: 12, p: "Undergear/MR Check", lp: "YES", alp: "YES"},
            {id: 13, p: "Headlight Dimming", lp: "Yes/DAY", alp: "Yes/DAY"}
        ]},
        { title: "At CHO (Sign OFF)", points: [
            {id: 14, p: "A9 & SA9 Application", lp: "YES", alp: "YES"},
            {id: 15, p: "Reverser Neutral", lp: "YES", alp: "YES"},
            {id: 16, p: "Packing Belongings", lp: "Yes", alp: "Yes"},
            {id: 17, p: "Abnormalities", lp: "NIL", alp: "NIL"}
        ]}
    ];

    const container = document.getElementById('observationSections');
    sections.forEach(sec => {
        let html = `<div class="section-header">${sec.title}</div><div class="bg-white border-x border-b divide-y">`;
        sec.points.forEach(pt => {
            html += `
            <div class="grid grid-cols-12 gap-1 p-2 items-center" id="row_${pt.id}">
                <div class="col-span-6 point-text">${pt.id}. ${pt.p}</div>
                <div class="col-span-3 flex flex-col gap-1 items-center border-r" id="lp_cell_${pt.id}">
                    <div class="flex items-center gap-1">
                        <span class="text-[8px] font-bold text-blue-600">LP</span>
                        ${pt.id===17 ? `<input type="text" name="lp_val_${pt.id}" value="NIL" oninput="checkV('lp',${pt.id},'NIL')" class="border text-[10px] w-full p-1 uppercase">` :
                        `<select name="lp_val_${pt.id}" onchange="checkV('lp',${pt.id},'${pt.lp}')"><option>${pt.lp}</option><option>POOR</option><option>VIOLATION</option></select>`}
                    </div>
                    <div id="lp_up_${pt.id}" class="hidden"><input type="file" name="img_lp_${pt.id}" class="text-[7px] w-full"></div>
                </div>
                <div class="col-span-3 flex flex-col gap-1 items-center" id="alp_cell_${pt.id}">
                    <div class="flex items-center gap-1">
                        <span class="text-[8px] font-bold text-orange-600">ALP</span>
                        ${pt.id===17 ? `<input type="text" name="alp_val_${pt.id}" value="NIL" oninput="checkV('alp',${pt.id},'NIL')" class="border text-[10px] w-full p-1 uppercase">` :
                        `<select name="alp_val_${pt.id}" onchange="checkV('alp',${pt.id},'${pt.alp}')"><option>${pt.alp}</option><option>POOR</option><option>VIOLATION</option></select>`}
                    </div>
                    <div id="alp_up_${pt.id}" class="hidden"><input type="file" name="img_alp_${pt.id}" class="text-[7px] w-full"></div>
                </div>
            </div>`;
        });
        html += `</div>`; container.innerHTML += html;
    });

    // Lookup and other helper functions (Same as previous, omitted for brevity but should be included)
    async function lookup(type) {
        let id = document.getElementById(type+'_id').value.toUpperCase();
        if(!id) return;
        try {
            let res = await fetch(GITHUB_RAW + (type==='cli'?'cli_master.csv':'crew_master.csv'));
            let text = await res.text();
            let found = text.split("\n").map(r=>r.split(",")).find(r=>r[0].trim().toUpperCase()===id);
            if(found) document.getElementById(type+'_name').value = found[1].trim();
        } catch(e) {}
    }

    function checkV(t, id, def) {
        let val = document.getElementsByName(t+'_val_'+id)[0].value;
        let isV = (id === 17) ? (val.toUpperCase() !== "NIL" && val !== "") : (val !== def);
        document.getElementById(t+'_up_'+id).classList.toggle('hidden', !isV);
        document.getElementById(t+'_cell_'+id).classList.toggle('violation-red', isV);
    }

    // FORM SUBMISSION WITH SYNC-FIRST LOGIC
    document.getElementById('cvvrsForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('statusMsg');
        
        btn.disabled = true;
        status.innerText = "⏳ STEP 1: UPLOADING TO GOOGLE DRIVE...";

        const fd = new FormData(this);
        const obj = Object.fromEntries(fd.entries());
        // Capture Manual Field values
        ['cli_id','cli_name','lp_name','alp_name','train_no','loco_no','dep_time','arr_time'].forEach(k => {
            const el = document.getElementById(k);
            if(el) obj[k] = el.value;
        });

        // Convert Photos
        const files = document.querySelectorAll('input[type="file"]');
        for (let f of files) {
            if (f.files[0]) {
                obj[f.name] = await new Promise(r => {
                    const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f.files[0]);
                });
            }
        }

        // STEP 1: Sync to Google Drive/Sheet
        try {
            const syncResponse = await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(obj) });
            
            // STEP 2: Wait for success then generate PDF
            status.innerText = "✅ SYNC COMPLETE! STEP 2: GENERATING PDF...";
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14); doc.text("CVVRS ANALYSIS REPORT", 105, 15, {align:'center'});
            // Add all header info and table as before...
            doc.save(`CVVRS_${obj.loco_no}.pdf`);
            
            alert("DATA SAVED & PDF DOWNLOADED SUCCESSFULLY!");
            location.reload();

        } catch(err) {
            alert("CRITICAL ERROR: Data could not be saved to Drive. Try again.");
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
