<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVVRS Smart Report | Mukesh Favorite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .loading { cursor: wait; opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-6 font-sans">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border-t-8 border-red-700">
        <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-wider">CVVRS CREW ANALYSIS SYSTEM</h1>
                <p class="text-sm text-gray-400">Personalized for Mukesh | Smart Reporting Engine</p>
            </div>
            <i class="fas fa-microchip text-4xl text-red-500"></i>
        </div>

        <form id="cvvrsForm" class="p-6 space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg border">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">CLI CMS ID</label>
                    <input type="text" id="cli_id" name="cli_id" required class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="Enter CLI ID" onchange="lookupCLI()">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Analysed by CLI</label>
                    <input type="text" id="cli_name" name="cli_name" readonly class="w-full border p-2 rounded bg-gray-100 font-bold">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Analysis Date</label>
                    <input type="date" id="analysis_date" name="analysis_date" required class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Train No</label>
                    <input type="text" id="train_no" name="train_no" required class="w-full border p-2 rounded">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Loco No & Base</label>
                    <input type="text" id="loco_no" name="loco_no" required class="w-full border p-2 rounded" placeholder="e.g. 37188/BIA">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">From (Station Code)</label>
                    <input type="text" id="from_stn_code" class="w-full border p-2 rounded" onchange="lookupStation('from')">
                    <input type="hidden" id="from_stn" name="from_stn">
                    <span id="label_from" class="text-[10px] text-blue-700 font-bold"></span>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">To (Station Code)</label>
                    <input type="text" id="to_stn_code" class="w-full border p-2 rounded" onchange="lookupStation('to')">
                    <input type="hidden" id="to_stn" name="to_stn">
                    <span id="label_to" class="text-[10px] text-blue-700 font-bold"></span>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Load</label>
                    <input type="text" id="load" name="load" class="w-full border p-2 rounded">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="p-4 border-l-4 border-blue-600 bg-blue-50 rounded-r-lg shadow-sm">
                    <h3 class="font-black text-blue-900 mb-3 flex justify-between">LOCO PILOT (LP) <span id="lp_hq_box" class="text-xs bg-white px-2 py-1 border rounded">HQ: <b id="lp_hq" class="text-red-600">-</b></span></h3>
                    <div class="space-y-3">
                        <input type="text" id="lp_id" name="lp_id" placeholder="CMS ID (Enter/Tab)" class="w-full border p-2 rounded uppercase" onchange="lookupCrew('lp')">
                        <input type="text" id="lp_name" name="lp_name" placeholder="Name" readonly class="w-full border p-2 rounded bg-white font-semibold">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="lp_desig" name="lp_desig" placeholder="Designation" readonly class="border p-2 rounded bg-white">
                            <input type="text" id="lp_gcli" name="lp_gcli" placeholder="Group CLI" readonly class="border p-2 rounded bg-white">
                        </div>
                    </div>
                </div>
                <div class="p-4 border-l-4 border-orange-600 bg-orange-50 rounded-r-lg shadow-sm">
                    <h3 class="font-black text-orange-900 mb-3 flex justify-between">ASST LOCO PILOT (ALP) <span id="alp_hq_box" class="text-xs bg-white px-2 py-1 border rounded">HQ: <b id="alp_hq" class="text-red-600">-</b></span></h3>
                    <div class="space-y-3">
                        <input type="text" id="alp_id" name="alp_id" placeholder="CMS ID (Enter/Tab)" class="w-full border p-2 rounded uppercase" onchange="lookupCrew('alp')">
                        <input type="text" id="alp_name" name="alp_name" placeholder="Name" readonly class="w-full border p-2 rounded bg-white font-semibold">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="alp_desig" name="alp_desig" placeholder="Designation" readonly class="border p-2 rounded bg-white">
                            <input type="text" id="alp_gcli" name="alp_gcli" placeholder="Group CLI" readonly class="border p-2 rounded bg-white">
                        </div>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto border rounded-lg shadow-inner">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-800 text-white uppercase text-xs">
                        <tr>
                            <th class="p-3">Analysis Point</th>
                            <th class="p-3 text-center">LP Status</th>
                            <th class="p-3 text-center">ALP Status</th>
                        </tr>
                    </thead>
                    <tbody id="obsTable" class="divide-y">
                        </tbody>
                </table>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center bg-gray-100 p-6 rounded-xl border-2 border-dashed border-gray-300">
                <div class="flex-1">
                    <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fas fa-camera mr-2"></i>Upload Analysis Screenshot (Optional)</label>
                    <input type="file" id="screenshot_file" accept="image/*" class="w-full text-sm">
                </div>
                <button type="submit" id="submitBtn" class="w-full md:w-64 bg-red-700 hover:bg-black text-white font-black py-4 rounded-lg shadow-lg transition-all transform hover:scale-105">
                    GENERATE REPORT & SYNC
                </button>
            </div>
        </form>
    </div>

    <script>
        // CONFIGURATION
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyy7OCSsp2zRLO02e8WKElz2i5QOC77OJPUu3QERLJGjNKAi8CcFu3gfAI5Vzh8xAb6/exec"; 
        const GITHUB_BASE = "https://raw.githubusercontent.com/PASTE_YOUR_GITHUB_USERNAME/PASTE_YOUR_REPO_NAME/main/";

        const obsPoints = [
            "Logbook/RS Valve Check", "Safety Items/HTC", "Energy Meter/SPM", "BFT & BPT / Holding RS",
            "Signal Call Out", "Mobile Phone Use", "Micro Sleep", "Exchange of Signals",
            "Neutral Section/Curve Lookback", "Alertness", "A9 & SA9 Application", "Reverser in Neutral",
            "Headlight Dimming", "Undergear/Machine Room", "Whistle/Exchange before Start", "Personal Belongings Packing"
        ];

        // Init Table
        const tbody = document.getElementById('obsTable');
        obsPoints.forEach((point, index) => {
            const num = index + 1;
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-medium text-gray-700">${num}. ${point}</td>
                    <td class="p-2">
                        <select name="lp_obs_${num}" class="w-full border p-1 rounded bg-white">
                            <option value="Yes">Yes</option><option value="No">No</option><option value="Good">Good</option><option value="Poor">Poor</option>
                        </select>
                    </td>
                    <td class="p-2">
                        <select name="alp_obs_${num}" class="w-full border p-1 rounded bg-white">
                            <option value="Yes">Yes</option><option value="No">No</option><option value="Good">Good</option><option value="Poor">Poor</option>
                        </select>
                    </td>
                </tr>`;
        });

        // Lookup Helpers
        async function fetchCSV(file) {
            const response = await fetch(GITHUB_BASE + file + ".csv");
            const text = await response.text();
            return text.split("\n").map(row => row.split(",").map(cell => cell.trim()));
        }

        async function lookupCLI() {
            const id = document.getElementById('cli_id').value.toUpperCase();
            const data = await fetchCSV("cli_master");
            const found = data.find(r => r[0] === id);
            document.getElementById('cli_name').value = found ? found[1] : "NOT FOUND";
        }

        async function lookupCrew(type) {
            const id = document.getElementById(type + '_id').value.toUpperCase();
            if(!id) return;
            
            // Auto HQ Extraction (e.g., SDL from SDL2058)
            const hq = id.match(/^[a-zA-Z]+/);
            document.getElementById(type + '_hq').innerText = hq ? hq[0] : "-";

            const data = await fetchCSV("crew_master");
            const found = data.find(r => r[0] === id);
            if(found) {
                document.getElementById(type + '_name').value = found[1];
                document.getElementById(type + '_desig').value = found[2];
                document.getElementById(type + '_gcli').value = found[3];
            }
        }

        async function lookupStation(field) {
            const code = document.getElementById(field + '_stn_code').value.toUpperCase();
            const data = await fetchCSV("station_master");
            const found = data.find(r => r[0] === code);
            if(found) {
                document.getElementById(field + '_stn').value = found[1];
                document.getElementById('label_' + field).innerText = found[1];
            }
        }

        // Form Submit
        document.getElementById('cvvrsForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "UPLOADING DATA...";

            const formData = new FormData(e.target);
            const dataObj = Object.fromEntries(formData.entries());

            // Handle Image
            const fileInput = document.getElementById('screenshot_file');
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = async () => {
                    dataObj.image = reader.result;
                    sendData(dataObj);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                sendData(dataObj);
            }
        };

        async function sendData(payload) {
            try {
                // We send as a query string for simplicity in the .gs side if needed, 
                // but for images, we use POST body.
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                alert("Report Sent Successfully to Google Drive & Sheet!");
                location.reload();
            } catch (err) {
                alert("Error: " + err);
                document.getElementById('submitBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
