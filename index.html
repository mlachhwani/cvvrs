<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVVRS ANALYSIS SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        .violation-red { background-color: #fee2e2 !important; border: 1px solid #ef4444 !important; }
        .cat-header { background: #facc15; color: #000; padding: 4px 10px; font-weight: 800; font-size: 11px; text-transform: uppercase; }
        .sub-header { background: #f8fafc; font-weight: 700; font-size: 10px; color: #475569; border-bottom: 1px solid #e2e8f0; }
        .point-text { font-size: 10px; line-height: 1.2; font-weight: 500; color: #1e293b; }
        select { font-size: 10px !important; padding: 1px !important; font-weight: bold; border: 1px solid #cbd5e1; width: 75px; h-6; }
        input[type="text"] { font-size: 11px; }
        input:read-only { background-color: #f1f5f9; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-200 p-2">

<div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-sm overflow-hidden border-t-4 border-blue-900">
    <div class="p-3 bg-slate-50 border-b grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
            <label class="block text-[9px] font-bold text-gray-500">CLI CMS ID</label>
            <input type="text" id="cli_id" name="cli_id" onchange="lookup('cli')" class="w-full border p-1 uppercase font-bold">
            <input type="text" id="cli_name" readonly class="w-full text-[10px] font-bold text-blue-800 bg-transparent outline-none">
        </div>
        <div>
            <label class="block text-[9px] font-bold text-gray-500">TRAIN NO & LOCO NO</label>
            <div class="flex gap-1">
                <input type="text" id="train_no" placeholder="TRAIN" class="w-1/2 border p-1 font-bold uppercase">
                <input type="text" id="loco_no" placeholder="LOCO" class="w-1/2 border p-1 font-bold uppercase">
            </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
            <div><label class="block text-[9px] font-bold text-gray-500">DEPARTURE</label><input type="datetime-local" id="dep_time" class="w-full border p-1 text-[9px]"></div>
            <div><label class="block text-[9px] font-bold text-gray-500">ARRIVAL</label><input type="datetime-local" id="arr_time" class="w-full border p-1 text-[9px]"></div>
        </div>
    </div>

    <form id="cvvrsForm">
        <div class="grid grid-cols-2 divide-x border-b bg-gray-50">
            <div class="p-2">
                <div class="text-[9px] font-bold text-blue-600 mb-1 uppercase">LOCO PILOT (LP)</div>
                <input type="text" id="lp_id" name="lp_id" onchange="lookup('lp')" placeholder="LP ID" class="w-full border p-1 text-xs font-bold uppercase mb-1">
                <input type="text" id="lp_name" readonly class="w-full text-[10px] font-bold text-gray-600 outline-none" placeholder="LP Name">
            </div>
            <div class="p-2">
                <div class="text-[9px] font-bold text-orange-600 mb-1 uppercase">ASTT. LOCO PILOT (ALP)</div>
                <input type="text" id="alp_id" name="alp_id" onchange="lookup('alp')" placeholder="ALP ID" class="w-full border p-1 text-xs font-bold uppercase mb-1">
                <input type="text" id="alp_name" readonly class="w-full text-[10px] font-bold text-gray-600 outline-none" placeholder="ALP Name">
            </div>
        </div>

        <div class="grid grid-cols-12 cat-header border-b">
            <div class="col-span-4">Category & LP Points</div>
            <div class="col-span-2 text-center">LP Resp</div>
            <div class="col-span-4">ALP Points</div>
            <div class="col-span-2 text-center">ALP Resp</div>
        </div>

        <div id="observationBody"></div>

        <div class="p-4 bg-slate-100 text-center border-t">
            <p id="statusMsg" class="mb-2 text-[10px] font-bold text-red-600 uppercase"></p>
            <button type="submit" id="submitBtn" class="bg-blue-900 text-white px-10 py-3 rounded font-bold text-xs hover:bg-black transition-all">
                SYNCHRONIZE DATA & DOWNLOAD REPORT
            </button>
        </div>
    </form>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby__yyf6tBaMvI69wNqBSqmquKAyqB2cpLhhxBkfP_GXYGN7ysw8Yvtr4mQ5p_19p-q/exec";
    const GITHUB_RAW = "https://raw.githubusercontent.com/mlachhwani/cvvrs/main/";

    const layout = [
        { cat: "During CTO", points: [
            { lp: "Checking Logbook & BPC", lp_d: "YES", alp: "Checking RS Valve working", alp_d: "Yes" },
            { lp: "Checking Safety Items & HTC", lp_d: "YES", alp: "Checking Safety Items & HTC", alp_d: "Yes" },
            { lp: "Energy Meter & SPM check", lp_d: "YES", alp: "Energy Meter & SPM check & Input", alp_d: "Yes" }
        ]},
        { cat: "ON RUN", points: [
            { lp: "Conducting BFT & BPT", lp_d: "YES", alp: "Standing & Holding RS (Danger Signal)", alp_d: "Yes" },
            { lp: "Calling Out Signals (Gesture)", lp_d: "YES", alp: "Calling Out Signals (Gesture)", alp_d: "Yes" },
            { lp: "Use of Mobile Phone", lp_d: "No", alp: "Use of Mobile Phone", alp_d: "No" },
            { lp: "Micro Sleep", lp_d: "No", alp: "Micro Sleep", alp_d: "No" },
            { lp: "Exchange of Signals", lp_d: "YES", alp: "Exchange of Signals", alp_d: "Yes" },
            { lp: "Action during Neutral Section", lp_d: "YES", alp: "Formation in curve & Caution", alp_d: "Yes" },
            { lp: "Alertness", lp_d: "Very Good", alp: "Alertness", alp_d: "Very Good" }
        ]},
        { cat: "AT HALTS", points: [
            { lp: "Application of A9 & SA9", lp_d: "YES", alp: "Ensure Application of A9 & SA9", alp_d: "YES" },
            { lp: "Reverser in Neutral", lp_d: "YES", alp: "Ensure Reverser in Neutral", alp_d: "YES" },
            { lp: "Dimming of Headlight", lp_d: "Yes/DAY TIME", alp: "Ensure Dimming of Headlight", alp_d: "Yes/DAY TIME" },
            { lp: "Undergear & Machine Room", lp_d: "YES", alp: "Undergear & Machine Room", alp_d: "YES" },
            { lp: "Proper whistle before start", lp_d: "YES", alp: "Proper Signal Exchange before start", alp_d: "YES" }
        ]},
        { cat: "At the Time of CHO", points: [
            { lp: "Packing of Personal belongings", lp_d: "Yes", alp: "Packing of Personal belongings", alp_d: "Yes" },
            { lp: "Overall Performance", lp_d: "Very Good", alp: "Any Other Abnormalities", alp_d: "Very Good" },
            { lp: "Any Other Abnormalities", lp_d: "NIL", alp: "Any Other Abnormalities", alp_d: "NIL" }
        ]}
    ];

    const obsBody = document.getElementById('observationBody');
    let pointCounter = 1;
    layout.forEach(sec => {
        obsBody.innerHTML += `<div class="sub-header px-2 py-1">${sec.cat}</div>`;
        sec.points.forEach(p => {
            obsBody.innerHTML += `
            <div class="grid grid-cols-12 gap-1 p-1 border-b items-center">
                <div class="col-span-4 point-text">${pointCounter}. ${p.lp}</div>
                <div class="col-span-2 flex flex-col items-center border-r" id="lp_cell_${pointCounter}">
                    <select name="lp_val_${pointCounter}" onchange="checkV('lp',${pointCounter},'${p.lp_d}')">
                        <option>${p.lp_d}</option><option>POOR</option><option>VIOLATION</option>
                    </select>
                    <input type="file" name="img_lp_${pointCounter}" class="hidden mt-1 text-[7px] w-full">
                </div>
                <div class="col-span-4 point-text pl-1">${p.alp}</div>
                <div class="col-span-2 flex flex-col items-center" id="alp_cell_${pointCounter}">
                    <select name="alp_val_${pointCounter}" onchange="checkV('alp',${pointCounter},'${p.alp_d}')">
                        <option>${p.alp_d}</option><option>POOR</option><option>VIOLATION</option>
                    </select>
                    <input type="file" name="img_alp_${pointCounter}" class="hidden mt-1 text-[7px] w-full">
                </div>
            </div>`;
            pointCounter++;
        });
    });

    async function lookup(type) {
        let id = document.getElementById(type+'_id').value.toUpperCase();
        if(!id) return;
        try {
            let res = await fetch(GITHUB_RAW + (type==='cli'?'cli_master.csv':'crew_master.csv'));
            let text = await res.text();
            let found = text.split("\n").map(r=>r.split(",")).find(r=>r[0].trim().toUpperCase()===id);
            if(found) document.getElementById(type+'_name').value = found[1].trim();
        } catch(e) {}
    }

    function checkV(t, id, def) {
        let sel = document.getElementsByName(t+'_val_'+id)[0];
        let file = document.getElementsByName('img_'+t+'_'+id)[0];
        let isV = (sel.value !== def);
        file.classList.toggle('hidden', !isV);
        document.getElementById(t+'_cell_'+id).classList.toggle('violation-red', isV);
    }

    document.getElementById('cvvrsForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('statusMsg');
        btn.disabled = true;
        status.innerText = "⏳ STEP 1: UPLOADING DATA TO GOOGLE CLOUD...";

        const fd = new FormData(this);
        const obj = Object.fromEntries(fd.entries());
        // Basic fields
        ['cli_id','cli_name','lp_name','alp_name','train_no','loco_no','dep_time','arr_time'].forEach(k => {
            const el = document.getElementById(k); if(el) obj[k] = el.value;
        });

        // Convert Photos
        const files = document.querySelectorAll('input[type="file"]');
        for (let f of files) {
            if (f.files[0]) {
                obj[f.name] = await new Promise(r => {
                    const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f.files[0]);
                });
            }
        }

        try {
            // STEP 1: Sync to Google Script
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(obj) });
            
            status.innerText = "✅ SYNC SUCCESSFUL! STEP 2: GENERATING REPORT...";
            
            // STEP 2: PDF Generation (Only after success)
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14); doc.text("CVVRS ANALYSIS REPORT", 105, 15, {align:'center'});
            doc.setFontSize(9);
            doc.text(`CLI: ${obj.cli_name} | TRAIN: ${obj.train_no} | LOCO: ${obj.loco_no}`, 15, 25);
            doc.text(`LP: ${obj.lp_name} | ALP: ${obj.alp_name}`, 15, 30);
            
            // Table generation here...
            doc.save(`CVVRS_${obj.loco_no}.pdf`);
            
            alert("REPORT SAVED TO DRIVE & DOWNLOADED!");
            location.reload();
        } catch(err) {
            alert("SYNC FAILED. Check connection.");
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
